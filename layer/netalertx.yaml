# METABEGIN
# X-Env-Layer-Name: netalertx
# X-Env-Layer-Category: application
# X-Env-Layer-Desc: NetAlertX monitoring system with Docker Compose
# X-Env-Layer-Version: 1.0.0
# X-Env-Layer-Requires: docker-debian-bookworm
#
# X-Env-VarRequires: IGconf_device_user1
#
# X-Env-VarPrefix: netalertx
#
# X-Env-Var-image: jokob-sk/netalertx:latest
# X-Env-Var-image-Desc: Docker image to use for NetAlertX
# X-Env-Var-image-Required: false
# X-Env-Var-image-Set: true
#
# X-Env-Var-port: 20211
# X-Env-Var-port-Desc: Port for NetAlertX web interface
# X-Env-Var-port-Required: false
# X-Env-Var-port-Set: true
# METAEND
---
mmdebstrap:
  customize-hooks:
    - chroot $1 systemctl enable docker.service
    - mkdir -p $1/opt/netalertx
    - |-
      cat <<- EOF > $1/opt/netalertx/docker-compose.yml
      services:
        netalertx:
          network_mode: host
          image: $IGconf_netalertx_image
          container_name: netalertx
          restart: unless-stopped
          cap_drop:
            - ALL
          cap_add:
            - NET_ADMIN
            - NET_RAW
            - NET_BIND_SERVICE
          volumes:
            - /opt/netalertx/data:/data:rw
            - /etc/localtime:/etc/localtime:ro
          tmpfs:
            - /tmp:uid=20211,gid=20211,mode=1700,rw,noexec,nosuid,nodev
          environment:
            - LISTEN_ADDR=0.0.0.0
            - PORT=$IGconf_netalertx_port
            - ALWAYS_FRESH_INSTALL=false
            - NETALERTX_DEBUG=0
          mem_limit: 2048m
          mem_reservation: 1024m
          cpu_shares: 512
          pids_limit: 512
          logging:
            driver: json-file
            options:
              max-size: 10m
              max-file: "3"
      EOF
    - mkdir -p $1/opt/netalertx/data
    - |-
      cat <<- 'EOF' > $1/etc/systemd/system/netalertx.service
      [Unit]
      Description=NetAlertX Network Monitoring
      Requires=docker.service
      After=docker.service network-online.target
      Wants=network-online.target
      
      [Service]
      Type=simple
      WorkingDirectory=/opt/netalertx
      ExecStartPre=-/usr/bin/docker compose pull --quiet
      ExecStart=/usr/bin/docker compose up --no-log-prefix
      ExecStop=/usr/bin/docker compose down
      Restart=always
      RestartSec=10
      
      [Install]
      WantedBy=multi-user.target
      EOF
    - chroot $1 systemctl enable netalertx.service
    - |-
      chroot $1 bash -c '{ for i in 1 2; do sleep .2; echo raspberry; done; } | passwd $IGconf_device_user1'
    - |-
      echo "Pre-pulling NetAlertX Docker image..."
      chroot $1 bash -c 'mkdir -p /var/lib/docker && dockerd --storage-driver vfs --data-root /var/lib/docker &
      DOCKER_PID=$!
      sleep 5
      for i in {1..30}; do
        if docker version >/dev/null 2>&1; then
          echo "Docker is ready"
          break
        fi
        echo "Waiting for Docker to start... ($i/30)"
        sleep 2
      done
      docker pull $IGconf_netalertx_image || echo "Warning: Failed to pre-pull image, will pull on first boot"
      kill $DOCKER_PID 2>/dev/null || true
      wait $DOCKER_PID 2>/dev/null || true'
