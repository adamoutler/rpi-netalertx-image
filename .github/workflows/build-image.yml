name: Build RPi NetAlertX Image

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      image_variant:
        description: 'NetAlertX image variant'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - production

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set NetAlertX image variant
        id: set-variant
        run: |
          VARIANT="${{ github.event.inputs.image_variant || 'dev' }}"
          
          if [ "$VARIANT" = "production" ]; then
            IMAGE="ghcr.io/jokob-sk/netalertx:latest"
          else
            IMAGE="ghcr.io/jokob-sk/netalertx-dev:latest"
          fi
          
          echo "variant=$VARIANT" >> $GITHUB_OUTPUT
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "Building with $VARIANT variant: $IMAGE"

      - name: Build Raspberry Pi OS image
        id: build
        uses: usimd/pi-gen-action@v1
        with:
          image-name: netalertx-rpi
          stage-list: stage0 stage1 stage2 stages/docker stages/netalertx
          verbose-output: false
          # User-configurable settings (hostname, username, password, locale, 
          # keyboard, timezone, WiFi) are intentionally omitted to allow
          # Raspberry Pi Imager to configure them at flash time
        env:
          NETALERTX_IMAGE: ${{ steps.set-variant.outputs.image }}

      - name: Compress and release image
        id: compress
        run: |
          IMAGE_PATH="${{ steps.build.outputs.image-path }}"
          BUILD_TIMESTAMP=$(date +%Y-%m-%d-%H%M%S)
          BUILD_DATE=$(date +%Y-%m-%d)
          
          # Add unique identifier for PR builds using full timestamp
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            OUTPUT_NAME="netalertx-rpi-pr${{ github.event.pull_request.number }}-${BUILD_TIMESTAMP}.img.gz"
            TAG_NAME="pr${{ github.event.pull_request.number }}-${BUILD_TIMESTAMP}"
            RELEASE_NAME="NetAlertX RPi Image (PR #${{ github.event.pull_request.number }}) ${BUILD_TIMESTAMP}"
            IS_PRERELEASE="true"
          else
            OUTPUT_NAME="netalertx-rpi-${BUILD_TIMESTAMP}.img.gz"
            TAG_NAME="v${BUILD_TIMESTAMP}"
            RELEASE_NAME="NetAlertX RPi Image ${BUILD_TIMESTAMP}"
            IS_PRERELEASE="false"
          fi
          
          echo "Compressing $IMAGE_PATH to $OUTPUT_NAME"
          gzip -c "$IMAGE_PATH" > "$OUTPUT_NAME"
          
          echo "output-file=$OUTPUT_NAME" >> $GITHUB_OUTPUT
          echo "build-date=$BUILD_TIMESTAMP" >> $GITHUB_OUTPUT
          echo "tag-name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release-name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "is-prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.compress.outputs.tag-name }}
          name: ${{ steps.compress.outputs.release-name }}
          body: |
            ## Raspberry Pi OS Image with NetAlertX Pre-configured
            
            **Build Date:** ${{ steps.compress.outputs.build-date }}
            **NetAlertX Variant:** ${{ steps.set-variant.outputs.image }}
            **Build Type:** ${{ github.event_name }}
            
            ### Features
            - 64-bit Raspberry Pi OS (Bookworm)
            - Docker & Docker Compose pre-installed
            - NetAlertX configured to start automatically
            - Compatible with Raspberry Pi Imager configuration
            
            ### Installation
            1. Download the .img.gz file below
            2. Flash with Raspberry Pi Imager
            3. **IMPORTANT**: Click the gear icon (⚙️) in RPi Imager to configure:
               - Username and password (required)
               - Hostname, WiFi, locale, timezone (optional)
            4. Boot and access NetAlertX at http://<pi-ip>:20211
            
            ### Notes
            - User configuration is handled by Raspberry Pi Imager at flash time
            - No default credentials - you must configure them in RPi Imager
          files: netalertx-rpi-*.img.gz
          draft: false
          prerelease: ${{ steps.compress.outputs.is-prerelease }}
