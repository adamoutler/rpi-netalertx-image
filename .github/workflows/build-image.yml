name: Build RPi NetAlertX Image

on:
  push:
    branches:
      - main
      - copilot/create-github-actions-workflow
  workflow_dispatch:
    inputs:
      image_variant:
        description: 'NetAlertX variant to use'
        required: false
        default: 'dev'
        type: choice
        options:
          - dev
          - production

permissions:
  contents: write

jobs:
  build-image:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-user-static \
            binfmt-support \
            debootstrap \
            debian-archive-keyring \
            systemd-container \
            xz-utils \
            python3 \
            python3-yaml \
            curl \
            git \
            fdisk \
            dosfstools \
            mtools \
            rsync \
            mmdebstrap \
            genimage \
            podman
          
          # Install bdebstrap
          sudo apt-get install -y bdebstrap || {
            echo "bdebstrap not available in apt, installing from pip"
            sudo pip3 install bdebstrap
          }
      
      - name: Clone rpi-image-gen
        run: |
          git clone https://github.com/raspberrypi/rpi-image-gen.git
          cd rpi-image-gen
          git log -1 --oneline
          
          # Install additional dependencies using their script
          echo "Installing rpi-image-gen dependencies..."
          sudo ./install_deps.sh || echo "Some dependencies may have failed, continuing..."
      
      - name: Copy configuration files to rpi-image-gen
        run: |
          cp -rv config rpi-image-gen/
          cp -rv layer rpi-image-gen/
          if [ -d layer-hooks ]; then
            cp -rv layer-hooks rpi-image-gen/
          fi
          
          # List what was copied
          echo "Configuration copied:"
          ls -la rpi-image-gen/config/
          ls -la rpi-image-gen/layer/
      
      - name: Build RPi image
        id: build-image
        env:
          FIRST_USER_NAME: pi
          FIRST_USER_PASS: raspberry
          IMAGE_VARIANT_INPUT: ${{ github.event.inputs.image_variant }}
        run: |
          cd rpi-image-gen
          
          # Determine which NetAlertX image to use (default to dev)
          IMAGE_VARIANT="${IMAGE_VARIANT_INPUT:-dev}"
          if [ "$IMAGE_VARIANT" = "production" ]; then
            NETALERTX_IMAGE="ghcr.io/jokob-sk/netalertx:latest"
            echo "Using NetAlertX PRODUCTION image: $NETALERTX_IMAGE"
          else
            NETALERTX_IMAGE="ghcr.io/jokob-sk/netalertx-dev:latest"
            echo "Using NetAlertX DEV image: $NETALERTX_IMAGE"
          fi
          
          # Set environment variables for user credentials if provided
          # Use secrets for first user if provided, otherwise fallback to defaults
          IGUSER="${FIRST_USER_NAME:-pi}"
          IGPASS="${FIRST_USER_PASS:-raspberry}"
          export IGconf_device_user1="${IGUSER}"
          export IGconf_device_pass1="${IGPASS}"
          export IGconf_docker_trust_user1="y"
          export IGconf_netalertx_image="$NETALERTX_IMAGE"
          export IGconf_netalertx_port="20211"
          
          # Create and set the APT key directory required by docker layer
          mkdir -p "$PWD/apt-keys"
          export IGconf_sys_apt_keydir="$PWD/apt-keys"
          
          echo "Default user '$IGconf_device_user1' will be created."
          echo "Use RPi Imager advanced options to override credentials."
          
          # Show available layers
          echo "Available layers:"
          ./rpi-image-gen layer --list | head -20
          
          # Build the image
          echo "Starting image build..."
          ./rpi-image-gen build -c ./config/netalertx.yaml -S . || {
            echo "❌ Build failed. Checking for logs..."
            find . -name "*.log" -exec echo "=== {} ===" \; -exec cat {} \;
            exit 1
          }
          
          # Find the generated image in the deploy directory
          DEPLOY_DIR=$(find ./work -type d -name "deploy-*" | head -n 1)
          echo "Deploy directory: $DEPLOY_DIR"
          
          if [ -z "$DEPLOY_DIR" ]; then
            echo "❌ Error: No deploy directory found"
            echo "Checking work directory structure:"
            find ./work -type d
            exit 1
          fi
          
          # The main bootable image should be in the deploy directory
          IMAGE_PATH=$(find "$DEPLOY_DIR" -maxdepth 1 -name "*.img" -type f ! -name "*.sparse" | head -n 1)
          echo "✅ Generated image: $IMAGE_PATH"
          
          if [ -z "$IMAGE_PATH" ]; then
            echo "❌ Error: No .img file found in deploy directory"
            echo "Contents of deploy directory:"
            ls -lh "$DEPLOY_DIR"
            exit 1
          fi
          
          # Get image info
          ls -lh "$IMAGE_PATH"
          
          # Create filename with build date
          BUILD_DATE=$(date +'%Y-%m-%d')
          IMAGE_NAME="netalertx-rpi-${BUILD_DATE}.img"
          
          # Move to workspace root with dated filename
          cp "$IMAGE_PATH" "../${IMAGE_NAME}"
          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          # Export step output so later steps can reference this file name
          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_OUTPUT
      
      - name: Compress image with gzip
        id: compress-image
        env:
          IMAGE_NAME: ${{ steps.build-image.outputs.IMAGE_NAME }}
        run: |
          echo "Compressing image with gzip..."
          gzip -9 -v "${IMAGE_NAME}"
          ls -lh "${IMAGE_NAME}.gz"
          echo "ARCHIVE_NAME=${IMAGE_NAME}.gz" >> $GITHUB_OUTPUT

      - name: Verify compressed archive
        run: |
          ARCHIVE="${{ steps.compress-image.outputs.ARCHIVE_NAME }}"
          echo "Checking for archive: $ARCHIVE"
          if [ -z "$ARCHIVE" ]; then
            echo "No archive name provided from compress step";
            ls -lah . || true;
            exit 1;
          fi
          if [ ! -f "$ARCHIVE" ]; then
            echo "Archive file not found: $ARCHIVE";
            ls -lah . || true;
            exit 1;
          fi
          echo "Archive verified: $ARCHIVE";

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: netalertx-image
          path: ${{ steps.compress-image.outputs.ARCHIVE_NAME }}
      
      - name: Generate release tag
        id: tag
        run: |
          TAG="v$(date +'%Y.%m.%d')-$(git rev-parse --short HEAD)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: NetAlertX RPi Image ${{ steps.tag.outputs.tag }}
          body: |
            # NetAlertX Raspberry Pi Image
            
            Raspberry Pi OS 64-bit image for Zero 2W and newer devices, pre-configured with Docker and NetAlertX.
            
            ## Installation
            
            In Raspberry Pi Imager:
            1. Select your Raspberry Pi
            2. Select the downloaded image: Operating System -> Use Custom -> the downloaded file
            3. Select the SD card to flash
            4. Press Next and proceed through the process
            
            ## First Boot
            
            - Default user: `pi`
            - Default password: `raspberry` (change immediately using `passwd` command)
            - NetAlertX starts automatically and is accessible at http://&lt;pi-ip&gt;:20211
            - Data persists at /opt/netalertx/data
            
            ## What's Included
            
            - Raspberry Pi OS (64-bit)
            - Docker & Docker Compose
            - NetAlertX (jokob-sk/netalertx:latest) configured to start on boot
            
            Built from commit: ${{ github.sha }}
          files: |
            ${{ steps.compress-image.outputs.ARCHIVE_NAME }}
          draft: false
          prerelease: false
