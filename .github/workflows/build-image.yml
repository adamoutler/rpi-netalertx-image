name: Build RPi NetAlertX Image

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      image_variant:
        description: 'NetAlertX image variant'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - production

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set NetAlertX image based on variant
        id: set-image
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VARIANT="${{ github.event.inputs.image_variant }}"
          else
            VARIANT="dev"
          fi
          
          if [ "$VARIANT" = "production" ]; then
            echo "NETALERTX_IMAGE=ghcr.io/jokob-sk/netalertx:latest" >> $GITHUB_OUTPUT
          else
            echo "NETALERTX_IMAGE=ghcr.io/jokob-sk/netalertx-dev:latest" >> $GITHUB_OUTPUT
          fi
          
          echo "Building with $VARIANT variant"

      - name: Create custom stage for Docker installation
        run: |
          mkdir -p custom-stage-docker/00-install-docker
          
          cat > custom-stage-docker/00-install-docker/00-run.sh << 'EOF'
          #!/bin/bash -e
          on_chroot << CHROOT
          # Install Docker using official script
          curl -fsSL https://get.docker.com | sh
          
          # Enable Docker service
          systemctl enable docker.service
          CHROOT
          EOF
          
          chmod +x custom-stage-docker/00-install-docker/00-run.sh
          
          cat > custom-stage-docker/prerun.sh << 'EOF'
          #!/bin/bash -e
          if [ ! -d "${ROOTFS_DIR}" ]; then
            copy_previous
          fi
          EOF
          
          chmod +x custom-stage-docker/prerun.sh

      - name: Create custom stage for NetAlertX
        run: |
          mkdir -p custom-stage-netalertx/00-setup-netalertx
          
          cat > custom-stage-netalertx/00-setup-netalertx/00-run.sh << 'EOFMAIN'
          #!/bin/bash -e
          
          NETALERTX_IMAGE="${{ steps.set-image.outputs.NETALERTX_IMAGE }}"
          
          on_chroot << 'CHROOT'
          # Create NetAlertX directory
          mkdir -p /opt/netalertx
          
          # Create docker-compose.yml
          cat > /opt/netalertx/docker-compose.yml << 'EOF'
          services:
            netalertx:
              container_name: netalertx
              image: ${NETALERTX_IMAGE}
              network_mode: host
              restart: unless-stopped
              read_only: true
              volumes:
                - netalertx_data:/app/config
              environment:
                - TZ=UTC
                - PORT=20211
              cap_drop:
                - ALL
              cap_add:
                - NET_ADMIN
                - NET_RAW
                - NET_BIND_SERVICE
              deploy:
                resources:
                  limits:
                    memory: 2048M
                  reservations:
                    memory: 1024M

          volumes:
            netalertx_data:
              driver: local
          EOF
          
          # Create systemd service
          cat > /etc/systemd/system/netalertx.service << 'EOF'
          [Unit]
          Description=NetAlertX Network Scanner
          Requires=docker.service
          After=docker.service
          
          [Service]
          Type=simple
          WorkingDirectory=/opt/netalertx
          Environment="NETALERTX_IMAGE=${NETALERTX_IMAGE}"
          ExecStartPre=-/usr/bin/docker compose pull
          ExecStart=/usr/bin/docker compose up
          ExecStop=/usr/bin/docker compose down
          Restart=always
          RestartSec=10
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          # Enable the service
          systemctl enable netalertx.service
          CHROOT
          EOFMAIN
          
          chmod +x custom-stage-netalertx/00-setup-netalertx/00-run.sh
          
          cat > custom-stage-netalertx/prerun.sh << 'EOF'
          #!/bin/bash -e
          if [ ! -d "${ROOTFS_DIR}" ]; then
            copy_previous
          fi
          EOF
          
          chmod +x custom-stage-netalertx/prerun.sh

      - name: Build Raspberry Pi OS image with pi-gen
        id: build
        uses: usimd/pi-gen-action@v1
        with:
          image-name: netalertx-rpi-${{ steps.set-image.outputs.NETALERTX_IMAGE == 'ghcr.io/jokob-sk/netalertx:latest' && 'production' || 'dev' }}
          stage-list: stage0 stage1 stage2 custom-stage-docker custom-stage-netalertx
          hostname: netalertx
          username: pi
          password: raspberry
          locale: en_US.UTF-8
          keyboard-layout: English (US)
          keyboard-keymap: us
          timezone: UTC
          verbose-output: true

      - name: Compress image
        id: compress
        run: |
          IMAGE_PATH="${{ steps.build.outputs.image-path }}"
          BUILD_DATE=$(date +%Y-%m-%d)
          OUTPUT_NAME="netalertx-rpi-${BUILD_DATE}.img.gz"
          
          echo "Compressing $IMAGE_PATH to $OUTPUT_NAME"
          gzip -c "$IMAGE_PATH" > "$OUTPUT_NAME"
          
          echo "output-file=$OUTPUT_NAME" >> $GITHUB_OUTPUT
          echo "build-date=$BUILD_DATE" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.compress.outputs.build-date }}
          name: NetAlertX RPi Image ${{ steps.compress.outputs.build-date }}
          body: |
            ## Raspberry Pi OS Image with NetAlertX Pre-configured
            
            **Build Date:** ${{ steps.compress.outputs.build-date }}
            **NetAlertX Variant:** ${{ steps.set-image.outputs.NETALERTX_IMAGE }}
            
            ### Features
            - 64-bit Raspberry Pi OS (Bookworm)
            - Docker & Docker Compose pre-installed
            - NetAlertX configured to start automatically
            - Default credentials: pi/raspberry
            - Compatible with Raspberry Pi Imager configuration
            
            ### Installation
            1. Download the .img.gz file below
            2. Flash with Raspberry Pi Imager
            3. Configure username/password in RPi Imager (recommended)
            4. Boot and access NetAlertX at http://<pi-ip>:20211
            
            ### Notes
            - NetAlertX pulls the Docker image on first boot
            - Change the default password if not configured in RPi Imager
          files: ${{ steps.compress.outputs.output-file }}
          draft: false
          prerelease: false
